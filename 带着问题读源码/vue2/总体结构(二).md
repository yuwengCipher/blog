---
title: Vue2-总体结构(二)
date: 2021-04-08
categories:
 - Vue
---

## 前言

前一小节，我们整理了 Vue 相关的属性，这一小节则通过框架自带的 demo 来梳理一下 Vue 整体的一个运行流程。

## 正文

首先我们找到本节 demo 目录，路径为 '/examples/commits'。将 index.html 中 vue 的引用路径改成 '<script src="../../dist/vue.js"></script>', 方便调试。

app.js 里调用了 Vue 构造函数，所以从这里开始吧。

    ```js
    new Vue({
        el: '#demo',
        data: {
            branches: ['master', 'dev'],
            currentBranch: 'master',
            commits: null
        },
        created: function () {
            this.fetchData()
        },
        watch: {
            currentBranch: 'fetchData'
        },
    ```

### new Vue() 之前做了什么

Vue 本身会进行一系列的初始化工作

1. /src/core/instance/index.js
    ```js
    initMixin(Vue)
    stateMixin(Vue)
    eventsMixin(Vue)
    lifecycleMixin(Vue)
    renderMixin(Vue)
    ```
2. /src/core/index.js
   ```js
    initGlobalAPI(Vue)
    Object.defineProperty(Vue.prototype, '$isServer', {
        get: isServerRendering
    })
   
    Object.defineProperty(Vue.prototype, '$ssrContext', {
        get () {
            return this.$vnode && this.$vnode.ssrContext
        }
    })
   
    Object.defineProperty(Vue, 'FunctionalRenderContext', {
        value: FunctionalRenderContext
    })
   
    Vue.version = '__VERSION__'
   ```
3. /src/core/global-api.js
    ```js
    initUse(Vue)
    initMixin(Vue)
    initExtend(Vue)
    initAssetRegisters(Vue)
    ```

### new Vue() 做了什么

new Vue() 实际上调用了自身的 _init 方法，从字典可知， _init 方法 在 '/src/core/instance/init.js' 中的 initMixin 方法里。
忽略部分代码后是这样的：

```js
    let uid = 0
    Vue.prototype._init = function (options?: Object) {
		const vm: Component = this
		// a uid
		vm._uid = uid++

		// 这个标识可以避免 vm 被观察系统观察
		vm._isVue = true
		// 将通过自定义策略合并配置项后的值赋值给 $options
		vm.$options = mergeOptions(
            resolveConstructorOptions(vm.constructor),
            options || {},
            vm
        )

		if (process.env.NODE_ENV !== 'production') {
            // 如果不是生产环境就初始化代理相关操作
			initProxy(vm)
		} else {
			vm._renderProxy = vm
		}

		vm._self = vm
        // 初始化声明周期
		initLifecycle(vm)
        // 初始化事件机制
		initEvents(vm)
        // 初始化渲染相关
		initRender(vm)
        // 调用 beforeCreate 钩子
		callHook(vm, 'beforeCreate')
        // 在 data 或 props 被处理前初始化注入
		initInjections(vm) // resolve injections before data/props
        // 初始化对 data 和 props 相关操作
		initState(vm)
        // 在 data 或 props 被处理后初始化注入
		initProvide(vm) // resolve provide after data/props
        // 调用 created 钩子
		callHook(vm, 'created')

        // 如果存在 el 属性，则进行挂载操作
		if (vm.$options.el) {
			vm.$mount(vm.$options.el)
		}
	}
```

从代码中的注释可以看出，_init 方法主要做了如下几件事：

1. 为 Vue 实例添加 $options 属性
2. 初始化相关属性。
3. 在渲染操作相关初始化完成之后和属性注入相关初始化之前调用 beforeCreate 钩子
4. 在依赖相关初始化完成之后和 Dom 挂载之前调用 created 钩子
5. 挂载 Dom 

### options 合并策略

